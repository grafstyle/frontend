name: verification & deploy

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:

    verification:
      name: Code verification
      runs-on: ubuntu-latest
      steps:

      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Lint Code Base
        uses: github/super-linter@v4
        env:

          VALIDATE_ALL_CODEBASE: false
          FILTER_REGEX_EXCLUDE: (.eslintrc.json, .eslintrc.json, .husky/ , .dockerignore, .editorconfig, .gitignore)
          VALIDATE_TYPESCRIPT_STANDARD: false
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
    deploy:
      name: Deploy to AWS
      needs: verification
      runs-on: ubuntu-latest
      steps:
        - name: Checkout source code
          uses: actions/checkout@v2
        - name: Generate Deployment Package
          run: zip -r deploy.zip . -x '*.git*'
        - name: Get timestamp
          uses: gerred/actions/current-time@master
          id: current-time
        - name: Run string replace
          uses: frabert/replace-string-action@master
          id: format-time
          with:
            pattern: '[:\.]+'
            string: "${{ steps.current-time.outputs.time }}"
            replace-with: '-'
            flags: 'g'
        - name: Deploy to EB
          uses: einaregilsson/beanstalk-deploy@v21
          with:
            aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            application_name: actuality-frontend
            environment_name: Actuality-frontend-env
            existing_bucket_name: actuality-data
            version_label: "actuality-${{ steps.format-time.outputs.replaced }}"
            region: us-east-1
            deployment_package: deploy.zip
